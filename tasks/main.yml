- name: Setup oh-my-zsh
  tasks:
    - name: Set home directory variable
      set_fact:
        home_dir: "{{ ansible_env.HOME }}"

    - name: Install zsh
      ansible.builtin.apt:
        name: zsh
        state: present
        mode: '0770'

    - name: Download oh-my-zsh
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh
        dest: /etc/zsh-install.sh

    - name: Run oh-my-zsh installer
      ansible.builtin.command: /etc/zsh-install.sh
      environment: 
        ZSH: "{{ home_dir }}/.oh-my-zsh"

    - name: Change shell to zsh
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        shell: /bin/zsh
    
    - name: Remove oh-my-zsh installer
      ansible.builtin.file:
        path: /etc/zsh-install.sh
        state: absent
    
    - name: Install powerlevel10k
      ansible.builtin.git:
        repo: https://github.com/ansible/ansible-examples.git
        dest: "{{ home_dir }}/.oh-my-zsh/custom/themes/powerlevel10k"
        single_branch: yes
        version: master
        depth: 1

    - name: Install syntax highlighting
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-syntax-highlighting.git
        dest: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-syntax-highlighting"
        single_branch: yes
        version: master
    
    - name: Install zsh-autosuggestions
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-autosuggestions
        dest: "{{ home_dir }}/.oh-my-zsh/custom/plugins/zsh-autosuggestions"
        single_branch: yes
        version: master
    
    - name: Copy zshrc
      ansible.builtin.template:
        src: zshrc
        dest: "{{ home_dir }}/.zshrc"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
    
    - name: Copy p10k.zsh
      ansible.builtin.template:
        src: p10k.zsh
        dest: "{{ home_dir }}/.p10k.zsh"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
    
    - name: Source zshrc
      ansible.builtin.command: source "{{ home_dir }}/.zshrc"
      args:
        executable: /bin/zsh

